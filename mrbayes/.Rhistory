library(ape)
library(magrittr)
seqdata.fn <- list.files(path="../sequences",pattern="fas",full.names=TRUE)
numsc <- length(seqdata.fn)
seqdata <- list()
for(i in 1:numsc){
seqdata[[i]] <- read.dna(seqdata.fn[i],format="fasta",as.matrix=FALSE) # NB as.matrix=FALSE required for NEXUS output as below
}
setwd("~/Projects/pangea-round2/mrbayes")
seqdata.fn <- list.files(path="../sequences",pattern="fas",full.names=TRUE)
numsc <- length(seqdata.fn)
seqdata <- list()
for(i in 1:numsc){
seqdata[[i]] <- read.dna(seqdata.fn[i],format="fasta",as.matrix=FALSE) # NB as.matrix=FALSE required for NEXUS output as below
}
seqdata.fn
seqdata.fn <- list.files(path="../sequences",pattern=".fas$",full.names=TRUE)
seqdata.fn
numsc <- length(seqdata.fn)
seqdata <- list()
i=1
seqdata[[i]] <- read.dna(seqdata.fn[i],format="fasta",as.matrix=FALSE) # NB as.matrix=FALSE required for NEXUS output as below
seqdata <- list()
for(i in 1:numsc){
seqdata[[i]] <- read.dna(seqdata.fn[i],format="fasta",as.matrix=FALSE) # NB as.matrix=FALSE required for NEXUS output as below
}
stubs <- rep("",numsc)
for(i in 1:numsc){
stubs[i] <- seqdata.fn[i] %>% strsplit(.,"/") %>% unlist %>% tail(.,1) %>% strsplit(.,".",fixed=TRUE) %>% unlist %>% head(.,1)
}
stubs
for(i in 1:numsc){
s <- seqdata[[i]]
ids <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
ids <- gsub("IDPOP_","",ids,fixed=TRUE)
ids <- paste("X",ids,sep="")
st <- names(s) %>% strsplit(.,"_|\\|") %>% lapply(.,tail,1) %>% unlist %>% as.double
mf <- names(s) %>% grepl("\\-MALE|\\M\\|",.)
d <- data.frame(id=names(s),newid=ids,sampletime=st,male=mf)
write.table(d,paste(stubs[i],"_annotations.txt",sep=""),col.names=TRUE,row.names=FALSE,quote=FALSE,sep="\t")
}
for(i in 1:8){
s <- seqdata[[i]]
ids <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
ids <- gsub("IDPOP_","",ids,fixed=TRUE)
ids <- paste("X",ids,sep="")
names(s) <- ids
write.nexus.data(as.character(s),paste(stubs[i],".nex",sep=""),format="dna",interleaved=FALSE)
}
for(i in 9:numsc){
s <- seqdata[[i]]
ids <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
ids <- paste("X",ids,sep="")
names(s) <- ids
write.nexus.data(as.character(s),paste(stubs[i],".nex",sep=""),format="dna",interleaved=FALSE)
}
for(i in 1:8){
s <- seqdata[[i]]
ids <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
#ids <- gsub("IDPOP_","",ids,fixed=TRUE)
#ids <- paste("X",ids,sep="")
st <- names(s) %>% strsplit(.,"_|\\|") %>% lapply(.,tail,1) %>% unlist %>% as.double
mf <- names(s) %>% grepl("\\-MALE|\\M\\|",.)
d <- data.frame(id=names(s),newid=ids,sampletime=st,male=mf)
write.table(d,paste(stubs[i],"_annotations.txt",sep=""),col.names=TRUE,row.names=FALSE,quote=FALSE,sep="\t")
}
i=9
s <- seqdata[[i]]
ids <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
ids
id1 <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
id2 <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,2) %>% unlist %>% as.character
id1
id2
id2 <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,"[",2) %>% unlist %>% as.character
id2
id1
id2
st <- names(s) %>% strsplit(.,"_|\\|") %>% lapply(.,tail,1) %>% unlist %>% as.double
mf <- names(s) %>% grepl("\\-MALE|\\M\\|",.)
st
mf
mf <- names(s) %>% grepl("\\-MALE|\\M\\|",.)
mf <- names(s) %>% grepl("\\-MALE|\\M\\|",.)
for(i in 9:numsc){
s <- seqdata[[i]]
id1 <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
id2 <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,"[",2) %>% unlist %>% as.character
ids <- paste(id1,id2,sep="_")
st <- names(s) %>% strsplit(.,"_|\\|") %>% lapply(.,tail,1) %>% unlist %>% as.double
mf <- names(s) %>% grepl("\\-MALE|\\M\\|",.)
d <- data.frame(id=names(s),newid=ids,sampletime=st,male=mf)
write.table(d,paste(stubs[i],"_annotations.txt",sep=""),col.names=TRUE,row.names=FALSE,quote=FALSE,sep="\t")
}
for(i in 9:numsc){
s <- seqdata[[i]]
id1 <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
id2 <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,"[",2) %>% unlist %>% as.character
ids <- paste(id1,id2,sep="_")
names(s) <- ids
write.nexus.data(as.character(s),paste(stubs[i],".nex",sep=""),format="dna",interleaved=FALSE)
}
villages.partition <- "
charset gag = 1-1479;
charset pol = 1480-4479;
charset env = 4480-6987;
partition villages = 3: gag, pol, env;
set partition = villages;
"
regional.partition <- "
charset gag = 1-1440;
charset pol = 1441-4284;
charset env = 4285-6807;
partition regional = 3: gag, pol, env;
set partition = regional;
"
partition.vec <- rep("",numsc)
seqdata.fn
partition.vec <- rep("",numsc)
partition.vec[grep("Regional",seqdata.fn)] <- regional.partition
partition.vec[grep("Vill",seqdata.fn)] <- villages.partition
relaxedclock <- "
set autoclose=yes;
lset applyto=(all) nst=6 rates=invgamma ngammacat=4;
prset statefreqpr=Dirichlet(1.0,1.0,1.0,1.0);
unlink statefreq=(all) revmat=(all) shape=(all) pinvar=(all);
prset applyto=(all) ratepr=variable;
prset brlenspr=clock:uniform;
prset topologypr=fixed(tree_1);
prset clockratepr=lognorm(-9.0,1.0);
prset clockvar=igr;
prset nodeagepr=calibrated;
"
clock.vec <- rep(relaxedclock,numsc)
calibrations.list <- list()
for(i in 1:numsc){
s <- seqdata[[i]]
ids <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
ids <- gsub("IDPOP_","",ids,fixed=TRUE)
ids <- paste("X",ids,sep="")
tipdates <- names(s) %>% strsplit(.,"_|\\|") %>% lapply(.,tail,1) %>% unlist %>% as.double
tipage <- -(tipdates-max(tipdates))
numseqs <- length(s)
mbblock <- rep("",numseqs)
for(j in 1:numseqs){
tipname <- ids[j]
#mbblock[j] <- paste("calibrate ",tipname,"=Uniform(",tipage[j],",",tipage[j],");",sep="")
mbblock[j] <- paste("calibrate ",tipname,"=fixed(",tipage[j],");",sep="")
}
mbblock <- paste(mbblock,collapse="\n")
calibrations.list[[i]] <- mbblock
}
mcmcpars <- "
mcmc ngen=110000000 nruns=2 nchains=1 samplefreq=10000;
"
mcmc.vec <- rep(mcmcpars,numsc)
for(i in 1:numsc){
myseqs.nex <- paste(readLines(paste(stubs[i],".nex",sep="")),collapse="\n")
myseqs.nex <- gsub("DATATYPEDNA","DATATYPE=DNA",myseqs.nex,fixed=TRUE)
myseqs.mb <- sprintf("begin mrbayes;\n%s%s%s%send;\n",partition.vec[i],clock.vec[i],calibrations.list[[i]],mcmc.vec[i])
cat(myseqs.nex,myseqs.mb,file=paste(stubs[i],"_mb_clock.nex",sep=""),sep="\n")
}
calibrations.list <- list()
for(i in 1:8){
s <- seqdata[[i]]
ids <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
tipdates <- names(s) %>% strsplit(.,"_|\\|") %>% lapply(.,tail,1) %>% unlist %>% as.double
tipage <- -(tipdates-max(tipdates))
numseqs <- length(s)
mbblock <- rep("",numseqs)
for(j in 1:numseqs){
tipname <- ids[j]
#mbblock[j] <- paste("calibrate ",tipname,"=Uniform(",tipage[j],",",tipage[j],");",sep="")
mbblock[j] <- paste("calibrate ",tipname,"=fixed(",tipage[j],");",sep="")
}
mbblock <- paste(mbblock,collapse="\n")
calibrations.list[[i]] <- mbblock
}
for(i in 9:numsc){
s <- seqdata[[i]]
id1 <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
id2 <-  names(s) %>% strsplit(.,"\\-|\\|") %>% lapply(.,"[",2) %>% unlist %>% as.character
ids <- paste(id1,id2,sep="_")
tipdates <- names(s) %>% strsplit(.,"_|\\|") %>% lapply(.,tail,1) %>% unlist %>% as.double
tipage <- -(tipdates-max(tipdates))
numseqs <- length(s)
mbblock <- rep("",numseqs)
for(j in 1:numseqs){
tipname <- ids[j]
#mbblock[j] <- paste("calibrate ",tipname,"=Uniform(",tipage[j],",",tipage[j],");",sep="")
mbblock[j] <- paste("calibrate ",tipname,"=fixed(",tipage[j],");",sep="")
}
mbblock <- paste(mbblock,collapse="\n")
calibrations.list[[i]] <- mbblock
}
trees
trees.fn <- list.files(path="../raxml",pattern="bestTree")
trees.fn
trees.fn <- c(rep("",8),trees.fn)
seqdata.fn[9:16]
trees.fn <- list.files(path="../raxml",pattern="bestTree")
trees.fn <- c(rep("",8),trees.fn)
trees.fn <- list.files(path="../raxml",pattern="bestTree")
trees.fn <- c(rep("",8),trees.fn)
trees <- list()
for(i in 1:numsc){
trees[[i]] <- readLines(trees.fn[i])
}
trees.fn <- list.files(path="../raxml",pattern="bestTree")
trees.fn <- c(rep("",8),trees.fn)
trees <- list()
for(i in 1:numsc){
trees[[i]] <- readLines(paste("../raxml/",trees.fn[i],sep="")
}
trees.fn <- list.files(path="../raxml",pattern="bestTree")
trees.fn <- c(rep("",8),trees.fn)
trees <- list()
for(i in 1:numsc){
trees[[i]] <- readLines(paste("../raxml/",trees.fn[i],sep=""))
}
trees[[9]]
read.tree(text=trees[[9]])
unroot(read.tree(text=trees[[9]]))
tl <- tr$tip.label
i=9
tr <- trees[[i]]
tr <- read.tree(text=tr)
tr <- unroot(tr)
tl <- tr$tip.label
tl
tr <- trees[[i]]
tr <- read.tree(text=tr)
tr <- unroot(tr)
tl <- tr$tip.label
id1 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
id2 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,"[",2) %>% unlist %>% as.character
ids <- paste(id1,id2,sep="_")
tr$tip.label <- ids
tr
as.character(tr)
tr
?read.tree
write.tree(tr)
for(i in 9:numsc){
tr <- trees[[i]]
tr <- read.tree(text=tr)
tr <- unroot(tr)
tl <- tr$tip.label
id1 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
id2 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,"[",2) %>% unlist %>% as.character
ids <- paste(id1,id2,sep="_")
tr$tip.label <- ids
trees[[i]] <- write.tree(tr)
}
trees
for(i in 1:numsc){
myseqs.nex <- paste(readLines(paste(stubs[i],".nex",sep="")),collapse="\n")
myseqs.nex <- gsub("DATATYPEDNA","DATATYPE=DNA",myseqs.nex,fixed=TRUE)
mytrees.nex <- sprintf("begin trees;\n tree tree_1=%s\nend;\n")
myseqs.mb <- sprintf("begin mrbayes;\n%s%s%s%send;\n",partition.vec[i],clock.vec[i],calibrations.list[[i]],mcmc.vec[i])
cat(myseqs.nex,trees.nex,myseqs.mb,file=paste(stubs[i],"_mb_clock.nex",sep=""),sep="\n")
}
for(i in 1:numsc){
myseqs.nex <- paste(readLines(paste(stubs[i],".nex",sep="")),collapse="\n")
myseqs.nex <- gsub("DATATYPEDNA","DATATYPE=DNA",myseqs.nex,fixed=TRUE)
mytrees.nex <- sprintf("begin trees;\n tree tree_1=%s\nend;\n",trees[[i]])
myseqs.mb <- sprintf("begin mrbayes;\n%s%s%s%send;\n",partition.vec[i],clock.vec[i],calibrations.list[[i]],mcmc.vec[i])
cat(myseqs.nex,trees.nex,myseqs.mb,file=paste(stubs[i],"_mb_clock.nex",sep=""),sep="\n")
}
for(i in 1:numsc){
myseqs.nex <- paste(readLines(paste(stubs[i],".nex",sep="")),collapse="\n")
myseqs.nex <- gsub("DATATYPEDNA","DATATYPE=DNA",myseqs.nex,fixed=TRUE)
mytrees.nex <- sprintf("begin trees;\n tree tree_1=%s\nend;\n",trees[[i]])
myseqs.mb <- sprintf("begin mrbayes;\n%s%s%s%send;\n",partition.vec[i],clock.vec[i],calibrations.list[[i]],mcmc.vec[i])
cat(myseqs.nex,mytrees.nex,myseqs.mb,file=paste(stubs[i],"_mb_clock.nex",sep=""),sep="\n")
}
trees.fn <- list.files(path="../raxml",pattern="bestTree")
trees.fn <- c(rep("",8),trees.fn)
trees <- list()
for(i in 1:numsc){
trees[[i]] <- readLines(paste("../raxml/",trees.fn[i],sep=""))
}
for(i in 9:numsc){
tr <- trees[[i]]
tr <- read.tree(text=tr)
#tr <- unroot(tr)
tl <- tr$tip.label
id1 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
id2 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,"[",2) %>% unlist %>% as.character
ids <- paste(id1,id2,sep="_")
tr$tip.label <- ids
trees[[i]] <- write.tree(tr)
}
for(i in 1:numsc){
myseqs.nex <- paste(readLines(paste(stubs[i],".nex",sep="")),collapse="\n")
myseqs.nex <- gsub("DATATYPEDNA","DATATYPE=DNA",myseqs.nex,fixed=TRUE)
mytrees.nex <- sprintf("begin trees;\n tree tree_1=%s\nend;\n",trees[[i]])
myseqs.mb <- sprintf("begin mrbayes;\n%s%s%s%send;\n",partition.vec[i],clock.vec[i],calibrations.list[[i]],mcmc.vec[i])
cat(myseqs.nex,mytrees.nex,myseqs.mb,file=paste(stubs[i],"_mb_clock.nex",sep=""),sep="\n")
}
i=9
tr <- trees[[i]]
tr <- read.tree(text=tr)
#tr <- unroot(tr)
tl <- tr$tip.label
id1 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
id2 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,"[",2) %>% unlist %>% as.character
ids <- paste(id1,id2,sep="_")
tr$tip.label <- ids
tr
tr <- trees[[i]]
tr <- read.tree(text=tr)
#tr <- unroot(tr)
tl <- tr$tip.label
tl
trees.fn <- list.files(path="../raxml",pattern="bestTree")
trees.fn <- c(rep("",8),trees.fn)
trees <- list()
for(i in 1:numsc){
trees[[i]] <- readLines(paste("../raxml/",trees.fn[i],sep=""))
}
trees
i=9
?rtt
tr <- trees[[i]]
tr <- read.tree(text=tr)
tl <- tr$tip.label
tl
td <- tl %>% strsplit(.,"_",fixed=TRUE) %>% tail(.,1)
td
td <- tl %>% strsplit(.,"_",fixed=TRUE) %>% lapply(.,tail,1)
td
td <- tl %>% strsplit(.,"_",fixed=TRUE) %>% lapply(.,tail,1) %>% unlist %>% as.double
td
id1 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
id2 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,"[",2) %>% unlist %>% as.character
ids <- paste(id1,id2,sep="_")
tr$tip.label <- ids
tr <- unroot(tr)
tr.rtt <- rtt(tr,td,objective="rsquared")
plot(tr.rtt)
td
dr=distRoot(tr.rtt)
library(adephylo)
dr=distRoot(tr.rtt)
?distRoot
dr=distRoot(tr.rtt)
tr <- trees[[i]]
tr <- read.tree(text=tr)
tr <- unroot(tr)
tl <- tr$tip.label
td <- tl %>% strsplit(.,"_",fixed=TRUE) %>% lapply(.,tail,1) %>% unlist %>% as.double
id1 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
id2 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,"[",2) %>% unlist %>% as.character
ids <- paste(id1,id2,sep="_")
tr$tip.label <- ids
tr.rtt <- rtt(tr,td,objective="rsquared")
dr=distRoot(tr.rtt)
tr.rtt
hist(dr)
idx <- match(tr.rtt$tip.label,tl)
idx
tr.rtt$tip.label
tl
ids
idx <- match(tr.rtt$tip.label,ids)
idx
plot(dr~td[idx])
i=10
tr <- trees[[i]]
tr <- read.tree(text=tr)
tr <- unroot(tr)
tl <- tr$tip.label
td <- tl %>% strsplit(.,"_",fixed=TRUE) %>% lapply(.,tail,1) %>% unlist %>% as.double
id1 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
id2 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,"[",2) %>% unlist %>% as.character
ids <- paste(id1,id2,sep="_")
tr$tip.label <- ids
tr.rtt <- rtt(tr,td,objective="rsquared")
dr <- distRoot(tr.rtt)
idx <- match(tr.rtt$tip.label,ids)
plot(dr~td[idx])
trees.fn <- list.files(path="../raxml",pattern="bestTree")
trees.fn <- c(rep("",8),trees.fn)
trees <- list()
for(i in 1:numsc){
trees[[i]] <- readLines(paste("../raxml/",trees.fn[i],sep=""))
}
for(i in 9:numsc){
tr <- trees[[i]]
tr <- read.tree(text=tr)
tr <- unroot(tr)
tl <- tr$tip.label
td <- tl %>% strsplit(.,"_",fixed=TRUE) %>% lapply(.,tail,1) %>% unlist %>% as.double
id1 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,head,1) %>% unlist %>% as.character
id2 <-  tl %>% strsplit(.,"\\-|\\|") %>% lapply(.,"[",2) %>% unlist %>% as.character
ids <- paste(id1,id2,sep="_")
tr$tip.label <- ids
tr.rtt <- rtt(tr,td,objective="rsquared")
trees[[i]] <- write.tree(tr.rtt)
}
for(i in 1:numsc){
myseqs.nex <- paste(readLines(paste(stubs[i],".nex",sep="")),collapse="\n")
myseqs.nex <- gsub("DATATYPEDNA","DATATYPE=DNA",myseqs.nex,fixed=TRUE)
mytrees.nex <- sprintf("begin trees;\n tree tree_1=%s\nend;\n",trees[[i]])
myseqs.mb <- sprintf("begin mrbayes;\n%s%s%s%send;\n",partition.vec[i],clock.vec[i],calibrations.list[[i]],mcmc.vec[i])
cat(myseqs.nex,mytrees.nex,myseqs.mb,file=paste(stubs[i],"_mb_clock.nex",sep=""),sep="\n")
}
mcmcpars <- "
mcmc ngen=22000000 nruns=2 nchains=1 samplefreq=10000;
"
mcmc.vec <- rep(mcmcpars,numsc)
for(i in 1:numsc){
myseqs.nex <- paste(readLines(paste(stubs[i],".nex",sep="")),collapse="\n")
myseqs.nex <- gsub("DATATYPEDNA","DATATYPE=DNA",myseqs.nex,fixed=TRUE)
mytrees.nex <- sprintf("begin trees;\n tree tree_1=%s\nend;\n",trees[[i]])
myseqs.mb <- sprintf("begin mrbayes;\n%s%s%s%send;\n",partition.vec[i],clock.vec[i],calibrations.list[[i]],mcmc.vec[i])
cat(myseqs.nex,mytrees.nex,myseqs.mb,file=paste(stubs[i],"_mb_clock.nex",sep=""),sep="\n")
}
