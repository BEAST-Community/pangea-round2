```{r}
library(ape)
library(magrittr)
```

```{r}
s <- read.dna("Vill_99_Apr15/Vill_99_Apr15.fasta",format="fasta",as.matrix=TRUE)
tr <- read.nexus("Vill_99_Apr15/Vill_99_Apr15.nex")
tr$tip.label <- toupper(tr$tip.label)
tr2 <- tr
tl1 <- tr$tip.label  %>% strsplit(.,"-",fixed=TRUE) %>% lapply(.,"[",1) %>% unlist
tl2 <- tr$tip.label  %>% strsplit(.,"-",fixed=TRUE) %>% lapply(.,"[",2) %>% unlist
tl <- paste(tl1,tl2,sep="_")
tr2$tip.label <- tl
s2 <- s
id1 <- row.names(s) %>% strsplit(.,"-",fixed=TRUE) %>% lapply(.,"[",1) %>% unlist
id2 <- row.names(s) %>% strsplit(.,"-",fixed=TRUE) %>% lapply(.,"[",2) %>% unlist
row.names(s2) <- paste(id1,id2,sep="_")
#write.dna(s2,"vill.phy",format="interleaved")
```

```{r}
vill.tn93 <- dist.dna(s,model="TN93")
vill.nj <- nj(vill.tn93)
vill.nj.ph85 <- dist.topo(vill.nj,tr)
```

```{r}
cmd <- "FastTree -nt -gtr -nosupport Vill_99_Apr15/Vill_99_Apr15.fasta"
vill.ft <- system(cmd,intern=TRUE)
vill.ft.tr <- read.tree(text=vill.ft)
vill.ft.ph85 <- dist.topo(vill.ft.tr,tr)
treedist(vill.ft.tr,tr)
```

```{r}
vill.ex <- read.tree("ExaML_result.vill")
vill.ex.ph85 <- dist.topo(vill.ex,tr2)
```

Compare length of trees.

```{r}
vill.ex.tl <- sum(vill.ex$edge.length)
tr.tl <- sum(tr$edge.length)
sf <- vill.ex.tl/tr.tl
tr2.scaled <- tr2
tr2.scaled$edge.length <- tr2.scaled$edge.length*sf
write.tree(tr2.scaled,"vill_scaled.tre")
write.tree(tr2,"vill_unscaled.tre")
```

Run RAxML on scaled tree.

```{r}
cmd <- "raxmlHPC-PTHREADS-SSE3 -s vill.phy -f B -m GTRGAMMAI -n vill_scaled -T 4 -p 1 -q villages_partition -t vill_scaled.tre"
cmd <- "raxmlHPC-PTHREADS-SSE3 -s vill.phy -f e -m GTRGAMMAI -n vill_correct -T 4 -p 1 -q villages_partition -t vill_scaled.tre"
                                        #system(cmd)
```
